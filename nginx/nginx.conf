upstream user_service {
    least_conn;
    server user-service:3001 max_fails=3 fail_timeout=30s;
    server user-service-backup:3001 backup;
}

upstream restaurant_service {
    least_conn;
    server restaurant-service:3002 max_fails=3 fail_timeout=30s;
    server restaurant-service-backup:3002 backup;
}

upstream order_service {
    least_conn;
    server order-service:3003 max_fails=3 fail_timeout=30s;
    server order-service-backup:3003 backup;
}

upstream payment_service {
    least_conn;
    server payment-service:3004 max_fails=3 fail_timeout=30s;
    server payment-service-backup:3004 backup;
}

upstream frontend {
    server frontend:5173;
}

server {
    listen 80;
    server_name localhost;

    # Frontend
    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # User Service API
    location /api/auth {
        proxy_pass http://user_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Health check
        access_log off;
    }

    location /api/users {
        proxy_pass http://user_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Restaurant Service API
    location /api/restaurants {
        proxy_pass http://restaurant_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/menus {
        proxy_pass http://restaurant_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Order Service API
    location /api/carts {
        proxy_pass http://order_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/orders {
        proxy_pass http://order_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Payment Service API
    location /api/payments {
        proxy_pass http://payment_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Health checks for all services
    location /health/user {
        proxy_pass http://user_service/health;
        access_log off;
    }

    location /health/restaurant {
        proxy_pass http://restaurant_service/health;
        access_log off;
    }

    location /health/order {
        proxy_pass http://order_service/health;
        access_log off;
    }

    location /health/payment {
        proxy_pass http://payment_service/health;
        access_log off;
    }
}
